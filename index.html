<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIGER Agent - Authorize (MeshJS)</title>
    <!-- 1. Import React và MeshJS -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@meshsdk/react@1.1.12/dist/mesh-react.js"></script>
    <style>
        /* CSS giữ nguyên như cũ */
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: #2a2a2a; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); text-align: center; width: 90%; max-width: 500px; }
        h1 { color: #ffa500; margin-bottom: 30px; }
        button { background-color: #ffa500; color: #1a1a1a; border: none; padding: 15px 30px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; margin-top: 20px; }
        button:hover:not(:disabled) { background-color: #ffc107; transform: translateY(-2px); }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .info { margin-top: 30px; padding: 15px; background-color: #333; border-radius: 8px; word-wrap: break-word; }
        .info p { margin: 5px 0; }
        .status { margin-top: 20px; font-weight: bold; height: 24px; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <!-- 2. Thêm một div làm root cho ứng dụng React -->
    <div id="root"></div>

    <script type="text/javascript">
        // --- Bắt đầu Script MeshJS ---

        // Lấy các thành phần từ thư viện MeshJS
        const { MeshProvider, CardanoWallet } = MeshReact;
        const { useWallet } = MeshReact.hooks;

        // --- Component chính của ứng dụng ---
        function App() {
            const { wallet, connected, name, connecting, connect, disconnect } = useWallet();
            const [sessionId, setSessionId] = React.useState(null);
            const [walletAddress, setWalletAddress] = React.useState('');

            // Chạy một lần khi component được tải
            React.useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('session_id');
                setSessionId(id);
            }, []);

            // Chạy mỗi khi trạng thái 'connected' thay đổi
            React.useEffect(() => {
                async function getAddress() {
                    if (connected && wallet) {
                        const addresses = await wallet.getUsedAddresses();
                        setWalletAddress(addresses[0] || '');
                    } else {
                        setWalletAddress('');
                    }
                }
                getAddress();
            }, [connected, wallet]);

            // Hàm xử lý khi nhấn nút Authorize (cho bước sau)
            function handleAuthorize() {
                alert('Authorization logic will be implemented next!');
            }

            return React.createElement('div', { className: 'container' },
                React.createElement('h1', null, 'Authorize Test Session'),
                React.createElement('p', null, 'Connect your wallet to generate a temporary credential set for an automated E2E test.'),
                
                // 3. Thêm component nút Connect Wallet của MeshJS
                React.createElement('div', { style: { marginTop: '20px' } }, React.createElement(CardanoWallet)),

                // Chỉ hiển thị nút Authorize khi đã kết nối ví
                connected && React.createElement('button', { id: 'authBtn', onClick: handleAuthorize }, '2. Authorize Test Session'),

                // Hiển thị thông tin
                React.createElement('div', { className: 'info', style: { display: sessionId || connected ? 'block' : 'none' } },
                    sessionId && React.createElement('p', null, 
                        React.createElement('strong', null, 'Session ID: '),
                        React.createElement('span', null, sessionId)
                    ),
                    walletAddress && React.createElement('p', null,
                        React.createElement('strong', null, 'Wallet Address: '),
                        React.createElement('span', null, walletAddress)
                    )
                ),

                // Hiển thị trạng thái
                React.createElement('div', { className: 'status' },
                    !sessionId ? React.createElement('span', { className: 'error' }, 'ERROR: session_id not found in URL.') :
                    connecting ? 'Connecting...' :
                    connected ? React.createElement('span', { className: 'success' }, `Connected to ${name} wallet.`) : 'Please connect your wallet.'
                )
            );
        }

        // --- Render ứng dụng React ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            // 4. Bọc ứng dụng trong MeshProvider
            React.createElement(MeshProvider, null, React.createElement(App))
        );
    </script>
</body>
</html>